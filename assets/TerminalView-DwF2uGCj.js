import{f as O}from"./util-BTTZT_bN.js";import{W as K,a as X,x as Y}from"./xterm-CbIsyoms.js";import{C as G,Q as w,a as S,x as Z,D as ee,d as te,k as ae,b as oe,f as R,u as A,h as C,t as ie,o as L}from"./index-BA_zY1xG.js";import{_ as ne}from"./_plugin-vue_export-helper-DlAUqK2U.js";function h(i,o){window.parent?.postMessage({id:"-co-t-"+i,...o??{}})}const le=G("terminal-instance",()=>{let i=w(),o=w(),s=w(),u=w(),p,v=w(),r=w(),t=w();w();let F=new Map,f=new Set;const g=S(!1),j=Z(()=>i.value!=null);let m=S([]),x=-99999;const I=S();async function M(){i.value||(g.value=!0,console.log(":: booting wcInst..."),i.value=await K.boot({coep:"require-corp",workdirName:"project"}),console.log(":: booted wcInst"),window.WCINST=i.value,await i.value.setPreviewScript(`
            document.addEventListener("keydown",e=>{
                let k = e.key?.toLowerCase();
                if(k == "r" && e.ctrlKey){
                    e.preventDefault();
                    console.log(":: prevented reload",window.parent);
                    // window.parent?.postMessage({id:"--preview--",msg:"HI THERE!!"});
                    window.location.reload();
                }
            });
        `),i.value.on("server-ready",(a,e)=>{performance.now()-x>2e3&&m.value.splice(0,m.value.length),console.log("-----SERVER READY",a,e),m.value.push(e),x=performance.now(),h("update-preview-urls",{urls:ee(m.value)}),h("new-preview-url",{url:e,port:a})}),o.value=new X.FitAddon,s.value=new Y.Terminal({convertEol:!0}),s.value.loadAddon(o.value),u.value=await k(s.value),g.value=!1)}async function k(a){const e=await i.value.spawn("jsh",{terminal:{cols:a.cols,rows:a.rows}});let d=performance.now();return r.value=new WritableStream({write(n){a.write(n)},close:()=>{console.warn("on close?")}}),e.output.pipeTo(r.value),t.value=e,v.value=e.input.getWriter(),a.onData(n=>{console.log("--- ON DTA:",d),v.value.write(n)}),I.value=new Promise(n=>{}),e}function H(){let a=t.value;a.output.pipeTo(new WritableStream({write(e){s.value.write(e)}})),v.value=a.input.getWriter(),s.value.onData(e=>{v.value.write(e)})}async function N(a,e,d=!0,n){const l=await i.value.spawn(a,e);F.set(n,l),l.output.pipeTo(new WritableStream({write(P){s.value.write(P)}}));let E=new Promise(async P=>{let J=await l.exit;console.warn("EXIT CODE:",J),l.kill(),console.log("process exited",n,a,e),F.delete(n)});return d&&await E,l}async function B(){if(!i.value)return;const e=await(await i.value.spawn("npm",["init"])).exit;e!==0&&console.error(`Unable to run npm install ${e}`),await i.value.spawn("npm",["run","dev"])}async function V(a,e,d){if(i.value){if(d){let n=a.split("/");n.pop(),await W(n.join("/"),!0)}f.add(a),await i.value.fs.writeFile(a,e)}}async function W(a,e){f.add(a),await i.value.fs.mkdir(a,{recursive:e})}async function $(a){f.add(a),await i.value.fs.rm(a)}async function z(a){f.add(a),await i.value.fs.rm(a,{recursive:!0})}async function Q(a,e){f.add(a),f.add(e),await i.value.fs.rename(a,e)}async function U(a){await i.value.mount(a),console.log(":: mounted tree"),D()}let c=[],y=!1,_=!1;async function b(a){if(a&&c.push(a),!y){if(y=!0,await O(500),_){_=!1,y=!1,b(void 0);return}e:for(let e=0;e<c.length;e++){let d=c[e];if(d.id=="delete-item")for(let n=0;n<c.length;n++){if(e==n)continue;let l=c[n];if(l.id=="create-file"||l.id=="create-folder"){c[e]={id:l.id.replace("create","move"),data:{from:d.data.path,to:l.data.path,buf:l.data.buf}},c.splice(n,1),e=0;continue e}}}h("file-ops",{ops:c}),c=[],y=!1}}function D(){h("watcher-started"),console.warn(":: START WATCHER"),p&&T(),p=i.value.fs.watch("",{recursive:!0},async(a,e)=>{if(typeof e=="string"&&!e.includes("node_modules/")){if(f.has(e)){f.delete(e);return}if(a=="rename"){let d=await new Promise(l=>{i.value.fs.readFile(e).then(E=>{l({id:"create-file",data:{path:e,buf:E}})}).catch(()=>{console.warn("deleted FILE/FOLDER"),l({id:"delete-item",data:{path:e}})})}),n=await new Promise(l=>{i.value.fs.readdir(e).then(E=>{l({id:"create-folder",data:{path:e}})}).catch(()=>{l({id:"",data:void 0})})});d.id!=""&&n.id==""?(d.id=="delete-item"&&(_=!0),b(d)):n.id!=""&&b(n)}else i.value.fs.readFile(e).then(d=>{b({id:"change-file",data:{path:e,buf:d}})})}})}function T(){h("watcher-stopped"),p.close(),p=void 0}function q(){console.log(":: reset and terminated wcInst (embedded version)"),T(),o.value.dispose(),u.value.kill(),s.value.dispose(),i.value.teardown(),m.value=[],g.value=!1,x=-99999,o.value=void 0,u.value=void 0,s.value=void 0,i.value=void 0}return{wcInst:i,fitAddon:o,terminal:s,shellProcess:u,input:v,boot:M,startShell:k,startDevServer:B,booting:g,booted:j,onExit:I,processMap:F,previewURLs:m,saveFile:V,saveFolder:W,deleteFile:$,deleteFolder:z,moveItem:Q,loadTree:U,startFileWatcher:D,stopFileWatcher:T,spawnProcess:N,jsh:t,resumeJSH:H,$reset:q}}),se={key:0},re={key:1,class:"terminal-cont"},de=te({__name:"TerminalView",setup(i){const o=le(),s=ae("terminalEl");oe(async()=>{console.log("mounted terminal"),await O(1e3)});function u(r,t){window.parent?.postMessage({id:"-co-t-"+r,...t??{}})}self.addEventListener("message",async r=>{let t=r.data;console.log("terminal got message:",t),!(!t||typeof t!="object")&&t.id?.startsWith("-co-")&&(t.id=="-co-boot"?await p():t.id=="-co-reset"?o.$reset():t.id=="-co-refit"?o.fitAddon?.fit():t.id=="-co-write-file"?await o.saveFile(t.path,t.buf,!0):t.id=="-co-write-folder"?await o.saveFolder(t.path,t.recursive):t.id=="-co-delete-file"?await o.deleteFile(t.path):t.id=="-co-delete-folder"?await o.deleteFolder(t.path):t.id=="-co-move-item"?await o.moveItem(t.from,t.to):t.id=="-co-load-tree"?(await o.loadTree(t.tree),console.log(":time:",(Date.now()-t.start).toFixed(1))):t.id=="-co-spawn-process"&&(await o.spawnProcess(t.cmd,t.args,!1,t.pid),console.log(":: started new process:",t.pid,t.cmd,t.args)))});async function p(){if(o.booting||o.booted){console.warn("can't boot, either booting or already booted");return}u("booting"),await o.boot(),await v(),o.onExit.then(r=>{console.warn("terminal exited"),u("exit",{code:r}),o.$reset()}),u("booted")}async function v(){if(!s.value){console.warn("couldn't load terminal, there was no terminal element");return}s.value.style.width="200px";let r=o.terminal;r.open(s.value),o.fitAddon.fit(),r.textarea.autocomplete="none",window.addEventListener("resize",()=>{o.fitAddon.fit(),o.shellProcess.resize({cols:r.cols,rows:r.rows})}),console.log(":: FINISHED loading WC (embedded version)"),s.value.style.width=null,o.fitAddon.fit(),window.TS=o}return(r,t)=>A(o).booted?(L(),R("div",re,[C("div",{class:"terminal",ref_key:"terminalEl",ref:s},null,512)])):(L(),R("div",se,[C("h2",null,ie(A(o).booting?"Booting...":"Initializing..."),1)]))}}),ve=ne(de,[["__scopeId","data-v-3fef1fc5"]]);export{ve as default};
